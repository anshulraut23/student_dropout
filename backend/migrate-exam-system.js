// Migration script for exam management system
// Adds new tables and columns for standardized exam system

import Database from 'better-sqlite3';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const dbPath = path.join(__dirname, 'storage', 'education_assistant.db');
const db = new Database(dbPath);

console.log('\nüîÑ Starting Exam System Migration...\n');

try {
  // Enable foreign keys
  db.pragma('foreign_keys = OFF'); // Disable temporarily for migration

  // Step 1: Create new tables
  console.log('üìã Step 1: Creating new tables...');

  // Exam Templates table
  db.exec(`
    CREATE TABLE IF NOT EXISTS exam_templates (
      id TEXT PRIMARY KEY,
      schoolId TEXT NOT NULL,
      name TEXT NOT NULL,
      type TEXT NOT NULL,
      description TEXT,
      totalMarks INTEGER NOT NULL,
      passingMarks INTEGER NOT NULL,
      weightage REAL NOT NULL,
      orderSequence INTEGER NOT NULL,
      isActive INTEGER DEFAULT 1,
      createdAt TEXT NOT NULL,
      updatedAt TEXT NOT NULL,
      FOREIGN KEY (schoolId) REFERENCES schools(id)
    )
  `);
  console.log('  ‚úÖ exam_templates table created');

  // Exam Periods table
  db.exec(`
    CREATE TABLE IF NOT EXISTS exam_periods (
      id TEXT PRIMARY KEY,
      schoolId TEXT NOT NULL,
      templateId TEXT NOT NULL,
      academicYear TEXT NOT NULL,
      startDate TEXT NOT NULL,
      endDate TEXT NOT NULL,
      status TEXT DEFAULT 'scheduled',
      createdBy TEXT NOT NULL,
      createdAt TEXT NOT NULL,
      updatedAt TEXT NOT NULL,
      FOREIGN KEY (schoolId) REFERENCES schools(id),
      FOREIGN KEY (templateId) REFERENCES exam_templates(id),
      FOREIGN KEY (createdBy) REFERENCES users(id)
    )
  `);
  console.log('  ‚úÖ exam_periods table created');

  // Step 2: Check if exams table needs migration
  console.log('\nüìã Step 2: Checking exams table...');
  
  const tableInfo = db.prepare("PRAGMA table_info(exams)").all();
  const hasNewColumns = tableInfo.some(col => col.name === 'periodId');

  if (!hasNewColumns) {
    console.log('  üîÑ Migrating exams table...');
    
    // Create new exams table with updated schema
    db.exec(`
      CREATE TABLE exams_new (
        id TEXT PRIMARY KEY,
        schoolId TEXT NOT NULL,
        periodId TEXT,
        templateId TEXT,
        name TEXT NOT NULL,
        type TEXT NOT NULL,
        classId TEXT NOT NULL,
        subjectId TEXT NOT NULL,
        totalMarks INTEGER NOT NULL,
        passingMarks INTEGER NOT NULL,
        weightage REAL DEFAULT 1.0,
        examDate TEXT NOT NULL,
        duration INTEGER,
        instructions TEXT,
        syllabusTopics TEXT,
        createdBy TEXT NOT NULL,
        status TEXT DEFAULT 'scheduled',
        isAutoGenerated INTEGER DEFAULT 0,
        createdAt TEXT NOT NULL,
        updatedAt TEXT NOT NULL,
        FOREIGN KEY (schoolId) REFERENCES schools(id),
        FOREIGN KEY (periodId) REFERENCES exam_periods(id),
        FOREIGN KEY (templateId) REFERENCES exam_templates(id),
        FOREIGN KEY (classId) REFERENCES classes(id),
        FOREIGN KEY (subjectId) REFERENCES subjects(id),
        FOREIGN KEY (createdBy) REFERENCES users(id)
      )
    `);

    // Copy data from old table to new table
    db.exec(`
      INSERT INTO exams_new (
        id, schoolId, periodId, templateId, name, type, classId, subjectId,
        totalMarks, passingMarks, weightage, examDate, duration, instructions,
        syllabusTopics, createdBy, status, isAutoGenerated, createdAt, updatedAt
      )
      SELECT 
        id, schoolId, NULL, NULL, name, type, classId, subjectId,
        totalMarks, passingMarks, weightage, examDate, duration, instructions,
        syllabusTopics, createdBy, status, 0, createdAt, updatedAt
      FROM exams
    `);

    // Drop old table and rename new table
    db.exec('DROP TABLE exams');
    db.exec('ALTER TABLE exams_new RENAME TO exams');
    
    console.log('  ‚úÖ exams table migrated successfully');
  } else {
    console.log('  ‚úÖ exams table already up to date');
  }

  // Step 3: Create indexes
  console.log('\nüìã Step 3: Creating indexes...');

  // Exam templates indexes
  db.exec(`
    CREATE INDEX IF NOT EXISTS idx_exam_templates_school ON exam_templates(schoolId);
    CREATE INDEX IF NOT EXISTS idx_exam_templates_active ON exam_templates(isActive);
    CREATE INDEX IF NOT EXISTS idx_exam_templates_order ON exam_templates(orderSequence);
  `);
  console.log('  ‚úÖ exam_templates indexes created');

  // Exam periods indexes
  db.exec(`
    CREATE INDEX IF NOT EXISTS idx_exam_periods_school ON exam_periods(schoolId);
    CREATE INDEX IF NOT EXISTS idx_exam_periods_template ON exam_periods(templateId);
    CREATE INDEX IF NOT EXISTS idx_exam_periods_year ON exam_periods(academicYear);
    CREATE INDEX IF NOT EXISTS idx_exam_periods_status ON exam_periods(status);
    CREATE INDEX IF NOT EXISTS idx_exam_periods_dates ON exam_periods(startDate, endDate);
  `);
  console.log('  ‚úÖ exam_periods indexes created');

  // Exams indexes
  db.exec(`
    CREATE INDEX IF NOT EXISTS idx_exams_school ON exams(schoolId);
    CREATE INDEX IF NOT EXISTS idx_exams_period ON exams(periodId);
    CREATE INDEX IF NOT EXISTS idx_exams_template ON exams(templateId);
    CREATE INDEX IF NOT EXISTS idx_exams_class ON exams(classId);
    CREATE INDEX IF NOT EXISTS idx_exams_subject ON exams(subjectId);
    CREATE INDEX IF NOT EXISTS idx_exams_date ON exams(examDate);
    CREATE INDEX IF NOT EXISTS idx_exams_status ON exams(status);
    CREATE INDEX IF NOT EXISTS idx_exams_auto ON exams(isAutoGenerated);
  `);
  console.log('  ‚úÖ exams indexes created');

  // Re-enable foreign keys
  db.pragma('foreign_keys = ON');

  console.log('\n‚úÖ Migration completed successfully!\n');
  console.log('üìä Summary:');
  console.log('  - exam_templates table: Ready');
  console.log('  - exam_periods table: Ready');
  console.log('  - exams table: Updated with new columns');
  console.log('  - All indexes: Created');
  console.log('\nüéØ Next steps:');
  console.log('  1. Restart the backend server');
  console.log('  2. Test the new exam management system');
  console.log('  3. Create exam templates (admin)');
  console.log('  4. Schedule exam periods (admin)\n');

} catch (error) {
  console.error('\n‚ùå Migration failed:', error.message);
  console.error(error.stack);
  process.exit(1);
} finally {
  db.close();
}
